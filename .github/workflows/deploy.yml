name: Deploy to EC2

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. JDK 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle 캐시
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. gradlew 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. 빌드 실행 (테스트 제외)
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 6. 빌드 결과 확인
      - name: Check build output
        run: ls -al ./build/libs

      # 7. .env 파일 생성
      - name: Generate .env file
        run: |
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> .env
          echo "SERVER_PORT=${{ secrets.SERVER_PORT }}" >> .env
          echo "USER_SERVICE_URL=${{ secrets.USER_SERVICE_URL }}" >> .env
          echo "ITEM_SERVICE_URL=${{ secrets.ITEM_SERVICE_URL }}" >> .env
          echo "AUTH_SERVICE_URL=${{ secrets.AUTH_SERVICE_URL }}" >> .env
          echo "CALENDAR_SERVICE_URL=${{ secrets.CALENDAR_SERVICE_URL }}" >> .env
          echo "TEAM_SERVICE_URL=${{ secrets.TEAM_SERVICE_URL }}" >> .env
          echo "LOG_LEVEL=${{ secrets.LOG_LEVEL }}" >> .env

      # 8. EC2로 파일 전송 (JAR + 필요한 파일들)
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*.jar,.env,start.sh"
          target: /home/${{ secrets.EC2_USERNAME }}/api-gateway/

      # 9. 애플리케이션 배포
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo ">>> Move to api-gateway directory"
            cd /home/${{ secrets.EC2_USERNAME }}/api-gateway
            
            echo ">>> Setting permissions"
            chmod +x start.sh
            chmod 644 .env
            
            echo ">>> Loading env file"
            export $(grep -v '^#' .env | xargs)
            
            echo ">>> Stopping existing process"
            PID=$(lsof -ti:${{ secrets.SERVER_PORT }} 2>/dev/null)
            if [ ! -z "$PID" ]; then
              kill -9 $PID
              echo "Stopped process with PID: $PID"
              sleep 3
            else
              echo "No running process found"
            fi
            
            echo ">>> Creating logs directory"
            mkdir -p logs
            
            echo ">>> Finding JAR file"
            JAR_FILE=$(find build/libs -name "*.jar" | grep -v "plain.jar" | head -1)
            echo "JAR file: $JAR_FILE"
            
            echo ">>> Starting application"
            nohup java -jar $JAR_FILE > logs/application.log 2>&1 &
            APP_PID=$!
            echo "Application started with PID: $APP_PID"
            
            echo ">>> Waiting for application to start"
            sleep 5
            
            echo ">>> Health check"
            for i in {1..10}; do
              if curl -f http://localhost:${{ secrets.SERVER_PORT }}/actuator/health 2>/dev/null; then
                echo "✅ Application is running successfully!"
                exit 0
              fi
              echo "Waiting... ($i/10)"
              sleep 2
            done
            
            echo "⚠️ Health check failed - showing logs"
            tail -n 50 logs/application.log
            exit 1
